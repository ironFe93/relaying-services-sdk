(()=>{"use strict";var e={270:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ContractError=void 0;var a=r(752),s=function(e){function t(r){var a=e.call(this,"ContractError: ".concat(r))||this;return Object.setPrototypeOf(a,t.prototype),a}return a.__extends(t,e),t}(Error);t.ContractError=s},601:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ONE_NUMBER=t.ZERO_NUMBER=t.NOT_ADDRESS=t.ZERO_ADDRESS=void 0,t.ZERO_ADDRESS="0x0000000000000000000000000000000000000000",t.NOT_ADDRESS="0x",t.ZERO_NUMBER="0",t.ONE_NUMBER="1"},104:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Contracts=void 0;var a=r(752),s=r(593),n=r(820),i=r(270),o=a.__importDefault(r(622)),l=function(){function e(e,t,r){this.web3Instance=e,r=null!=r?r:{};var a={};try{a=(0,s.getContractAddresses)(t)}catch(e){if(!(e instanceof i.ContractError))throw e;o.default.warn(e)}this.addresses=(0,s.mergeConfiguration)(r,a),this.initialize()}return e.prototype.initialize=function(){try{this.smartWalletRelayVerifier=(0,s.getContract)(this.web3Instance,n.RelayVerifier.abi,this.addresses.smartWalletRelayVerifier),this.smartWalletDeployVerifier=(0,s.getContract)(this.web3Instance,n.DeployVerifier.abi,this.addresses.smartWalletDeployVerifier),o.default.debug("Contracts initialized correctly")}catch(e){throw new Error("Contracts fail to initialize: "+e.message)}},e.prototype.getSmartWalletFactory=function(){return this.smartWalletFactory||(this.smartWalletFactory=(0,s.getContract)(this.web3Instance,n.SmartWalletFactory.abi,this.addresses.smartWalletFactory)),this.smartWalletFactory},e.prototype.getSmartWalletRelayVerifier=function(){return this.smartWalletRelayVerifier||(this.smartWalletRelayVerifier=(0,s.getContract)(this.web3Instance,n.RelayVerifier.abi,this.addresses.smartWalletRelayVerifier)),this.smartWalletRelayVerifier},e.prototype.getSmartWalletDeployVerifier=function(){return this.smartWalletDeployVerifier||(this.smartWalletDeployVerifier=(0,s.getContract)(this.web3Instance,n.DeployVerifier.abi,this.addresses.smartWalletDeployVerifier)),this.smartWalletDeployVerifier},e}();t.Contracts=l},231:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultRelayingServices=void 0;var a=r(752),s=r(670),n=a.__importDefault(r(519)),i=r(820),o=r(593),l=r(601),c=r(104),d=r(76),u=a.__importDefault(r(622)),f=function(){function e(e,t){this.txId=777,this.web3Instance=e instanceof n.default?e:new n.default(e),this.account=t}return e.prototype.configure=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,r,n,i,l,c,d,f;return a.__generator(this,(function(h){switch(h.label){case 0:return h.trys.push([0,3,,4]),r=o.mergeConfiguration,n=[e],f={onlyPreferredRelays:!0,preferredRelays:["http://localhost:8090"],gasPriceFactorPercent:0,relayLookupWindowBlocks:1e5},[4,this.web3Instance.eth.getChainId()];case 1:return t=r.apply(void 0,n.concat([(f.chainId=h.sent(),f.relayVerifierAddress=this.contracts.addresses.smartWalletRelayVerifier,f.deployVerifierAddress=this.contracts.addresses.smartWalletDeployVerifier,f.smartWalletFactoryAddress=this.contracts.addresses.smartWalletFactory,f)])),i=t.relayHubAddress,l=a.__rest(t,["relayHubAddress"]),[4,(0,s.resolveConfiguration)(this.web3Instance.currentProvider,l)];case 2:return(c=h.sent()).relayHubAddress=null!=i?i:this.contracts.addresses.relayHub,[2,c];case 3:return d=h.sent(),u.default.log(d),[3,4];case 4:return[2]}}))}))},e.prototype.initialize=function(e,t,r){return a.__awaiter(this,void 0,void 0,(function(){var n,i,o,l,d,f,h;return a.__generator(this,(function(a){switch(a.label){case 0:return a.trys.push([0,5,,6]),this.setLogLevel(r.loglevel),n=this,i=c.Contracts.bind,o=[void 0,this.web3Instance],[4,this.web3Instance.eth.getChainId()];case 1:return n.contracts=new(i.apply(c.Contracts,o.concat([a.sent(),t]))),l=this,[4,this.web3Instance.eth.getAccounts()];case 2:return l.developmentAccounts=a.sent(),[4,this.configure(e)];case 3:return d=a.sent(),[4,(f=new s.RelayProvider(this.web3Instance.currentProvider,d)).relayClient._init()];case 4:return a.sent(),this.account&&f.addAccount({address:this.account.address,privateKey:Buffer.from(this.account.privateKey.replaceAll("0x",""),"hex")}),this.web3Instance.setProvider(f),this.relayProvider=f,u.default.debug("RelayingServicesSDK initialized correctly"),[3,6];case 5:return h=a.sent(),u.default.error("RelayingServicesSDK fail to initialize",h),[3,6];case 6:return[2]}}))}))},e.prototype.allowToken=function(e,t){return a.__awaiter(this,void 0,void 0,(function(){var r,s,n,l,c,d,f;return a.__generator(this,(function(a){switch(a.label){case 0:return u.default.debug("allowToken Params",{tokenAddress:e,account:t}),t||(t=this._getAccountAddress()),[4,new this.web3Instance.eth.Contract(i.DeployVerifier.abi,this.contracts.addresses.smartWalletDeployVerifier)];case 1:return r=a.sent(),[4,new this.web3Instance.eth.Contract(i.RelayVerifier.abi,this.contracts.addresses.smartWalletRelayVerifier)];case 2:s=a.sent(),a.label=3;case 3:return a.trys.push([3,6,,8]),l=r.methods.acceptToken(e),u.default.info(l),[4,l.send({from:t})];case 4:return a.sent(),n=!0,[4,s.methods.acceptToken(e).send({from:t})];case 5:return a.sent(),[3,8];case 6:return c=a.sent(),u.default.error(c),[4,(0,o.getRevertReason)(c.receipt.transactionHash)];case 7:throw d=a.sent(),f=n?"deploy":"relay",u.default.error("Error adding token with address ".concat(e," to allowed tokens on smart wallet ").concat(f," verifier"),d),c;case 8:return u.default.debug("Tokens allowed successfully!"),[2,e]}}))}))},e.prototype.isAllowedToken=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,r,s,n;return a.__generator(this,(function(a){switch(a.label){case 0:return u.default.debug("isAllowedToken Params",{tokenAddress:e}),t=this.contracts.getSmartWalletRelayVerifier(),r=this.contracts.getSmartWalletDeployVerifier(),[4,t.methods.acceptsToken(e).call()];case 1:return s=a.sent(),[4,r.methods.acceptsToken(e).call()];case 2:return n=a.sent(),[2,s&&n]}}))}))},e.prototype.getAllowedTokens=function(){return a.__awaiter(this,void 0,void 0,(function(){var e,t,r,s,n;return a.__generator(this,(function(i){switch(i.label){case 0:return e=this.contracts.getSmartWalletRelayVerifier(),t=this.contracts.getSmartWalletDeployVerifier(),[4,e.methods.getAcceptedTokens().call()];case 1:return r=i.sent(),[4,t.methods.getAcceptedTokens().call()];case 2:return s=i.sent(),n=new Set(a.__spreadArray(a.__spreadArray([],a.__read(r),!1),a.__read(s),!1)),[2,a.__spreadArray([],a.__read(n),!1)]}}))}))},e.prototype.claim=function(e){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(t){throw u.default.debug("claim Params",{commitmentReceipt:e}),new Error("NOT IMPLEMENTED: this will be available with arbiter integration.")}))}))},e.prototype.deploySmartWallet=function(e,t){return a.__awaiter(this,void 0,void 0,(function(){var r,s,n,i,o,c,d,f,h,y;return a.__generator(this,(function(a){switch(a.label){case 0:return u.default.debug("deploySmartWallet Params",{smartWallet:e,options:t}),r=e.address,s=e.index,n=t.tokenAddress,i=t.tokenAmount,o=t.recovererAddress,c=t.onlyPreferredRelays,d=t.callVerifier,f=t.callForwarder,u.default.debug("Checking if the wallet already exists"),[4,this.isSmartWalletDeployed(r)];case 1:if(a.sent())throw new Error("Smart Wallet already deployed");return u.default.debug("Deploying smart wallet for address",r),h={from:this._getAccountAddress(),to:l.ZERO_ADDRESS,callVerifier:null!=d?d:this.contracts.addresses.smartWalletDeployVerifier,callForwarder:null!=f?f:this.contracts.addresses.smartWalletFactory,tokenContract:null!=n?n:l.ZERO_ADDRESS,tokenAmount:i?i.toString():"0",data:"0x",index:s.toString(),recoverer:null!=o?o:l.ZERO_ADDRESS,isSmartWalletDeploy:!0,onlyPreferredRelays:c||!0,smartWalletAddress:r},[4,this.relayProvider.deploySmartWallet(h)];case 2:return y=a.sent(),u.default.debug("Smart wallet successfully deployed",y),[2,{deployment:{deployTransaction:y,tokenAddress:n},address:r,index:s}]}}))}))},e.prototype.generateSmartWallet=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,r;return a.__generator(this,(function(a){switch(a.label){case 0:return u.default.debug("generateSmartWallet Params",{smartWalletIndex:e}),u.default.debug("Generating computed address for smart wallet"),[4,this.contracts.getSmartWalletFactory().methods.getSmartWalletAddress(this._getAccountAddress(),l.ZERO_ADDRESS,e).call()];case 1:return t=a.sent(),console.debug("Checking if the wallet already exists"),[4,(0,o.addressHasCode)(this.web3Instance,t)];case 2:return r=a.sent(),[2,{address:t,index:e,deployed:r}]}}))}))},e.prototype.isSmartWalletDeployed=function(e){return u.default.debug("isSmartWalletDeployed Params",{smartWalletAddress:e}),(0,o.addressHasCode)(this.web3Instance,e)},e.prototype.relayTransaction=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,r,s,n,i,o,l,c,d,f,h,y,p,m=this;return a.__generator(this,(function(g){switch(g.label){case 0:return u.default.debug("relayTransaction Params",{options:e}),t=e.unsignedTx,r=e.smartWallet,s=e.tokenAmount,n=e.transactionDetails,i=e.value,o=e.onlyPreferredRelays,l=e.tokenAddress,u.default.debug("Checking if the wallet exists"),c=r.address,[4,this.isSmartWalletDeployed(c)];case 1:if(!g.sent())throw new Error("Smart Wallet is not deployed or the address ".concat(c," is not a smart wallet."));return y={jsonrpc:"2.0",id:++this.txId,method:"eth_sendTransaction"},p={from:this._getAccountAddress(),to:l,value:i?i.toString():"0",relayHub:this.contracts.addresses.relayHub,callVerifier:this.contracts.addresses.smartWalletRelayVerifier,callForwarder:c,data:t.data,tokenContract:l},[4,this.web3Instance.utils.toWei(s?s.toString():"0")];case 2:return y.params=[a.__assign.apply(void 0,[(p.tokenAmount=g.sent(),p.onlyPreferredRelays=null==o||o,p),n])],d=y,[4,new Promise((function(e,t){m.relayProvider._ethSendTransaction(d,(function(r,s){return a.__awaiter(m,void 0,void 0,(function(){var n;return a.__generator(this,(function(a){switch(a.label){case 0:return r&&t(r),[4,web3.eth.getTransactionReceipt(s.result)];case 1:return n=a.sent(),e(n),[2]}}))}))}))}))];case 3:if(!(f=g.sent()).status)throw h="Error relaying transaction",u.default.debug(h,f),new Error(h);return[2,f]}}))}))},e.prototype.estimateMaxPossibleRelayGas=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,r,s,n,i,o,c,u,f,h,y,p,m,g,_,v,b,w,R,W;return a.__generator(this,(function(A){switch(A.label){case 0:return t=e.destinationContract,r=e.smartWalletAddress,s=e.tokenFees,n=e.abiEncodedTx,i=e.relayWorker,o=e.tokenAddress,c=e.onlyPreferredRelays,u=e.callVerifier,f=e.isSmartWalletDeploy,h=e.callForwarder,y=e.index,p=e.recoverer,m=this.relayProvider.relayClient,g=this.web3Instance.utils.toWei(s),_=h||(f?this.contracts.addresses.smartWalletFactory:r),v=u||(f?this.contracts.addresses.smartWalletDeployVerifier:this.contracts.addresses.smartWalletRelayVerifier),b={from:this._getAccountAddress(),to:t||l.ZERO_ADDRESS,value:"0",relayHub:this.contracts.addresses.relayHub,callVerifier:v,callForwarder:_,data:n,tokenContract:o||this.contracts.addresses.testToken,tokenAmount:g.toString(),onlyPreferredRelays:null==c||c,isSmartWalletDeploy:f,smartWalletAddress:r},f?(b=a.__assign(a.__assign({},b),{index:y||"0",recoverer:p||l.ZERO_ADDRESS}),[3,4]):[3,1];case 1:return[4,m.getInternalCallCost(b)];case 2:return w=A.sent(),b.gas=(0,d.toHex)(w),[4,m.estimateTokenTransferGas(b,i)];case 3:R=A.sent().toString(),b.tokenGas=R,A.label=4;case 4:return[4,m.estimateMaxPossibleRelayGas(b,i)];case 5:return W=A.sent(),[2,this.calculateCostFromGas(W)]}}))}))},e.prototype.estimateMaxPossibleRelayGasWithLinearFit=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,r,s,n,i,o,l,c;return a.__generator(this,(function(a){switch(a.label){case 0:return u.default.debug("estimateMaxPossibleRelayGasWithLinearFit Params",e),t=e.destinationContract,r=e.smartWalletAddress,s=e.tokenFees,n=e.abiEncodedTx,i=e.relayWorker,[4,this.web3Instance.utils.toWei(s)];case 1:return o=a.sent(),l={from:this._getAccountAddress(),to:t,value:"0",relayHub:this.contracts.addresses.relayHub,callVerifier:this.contracts.addresses.smartWalletRelayVerifier,callForwarder:r,data:n,tokenContract:this.contracts.addresses.testToken,tokenAmount:o.toString(),onlyPreferredRelays:!0},[4,this.relayProvider.relayClient.estimateMaxPossibleRelayGasWithLinearFit(l,i)];case 2:return c=a.sent(),[2,this.calculateCostFromGas(c)]}}))}))},e.prototype.calculateCostFromGas=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,r;return a.__generator(this,(function(a){switch(a.label){case 0:return r=d.toBN,[4,this.relayProvider.relayClient._calculateGasPrice()];case 1:return t=r.apply(void 0,[a.sent()]),u.default.debug("calculateCostFromGas",{gas:e,gasPrice:t.toString()}),[2,(0,d.toBN)(e).mul(t).toString()]}}))}))},e.prototype._getAccountAddress=function(){return this.account?this.account.address:this.developmentAccounts[0]},e.prototype.setLogLevel=function(e){var t=null!=e?e:Number.parseInt(process.env.LOG_LEVEL);t>5||t<0||!t?console.log("Unknown log level specified, using default log level"):u.default.setLevel(t)},e}();t.DefaultRelayingServices=f},593:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getRevertReason=t.mergeConfiguration=t.getContractAddresses=t.getContract=t.addressHasCode=t.getAbiItem=void 0;var a=r(752),s=r(820),n=r(270);t.getAbiItem=function(e,t){var r=e.filter((function(e){return e.name===t}));if(r.length>0)return r[0];throw new Error("Item ".concat(t," doesn't exists on contract abi"))},t.addressHasCode=function(e,t){return a.__awaiter(this,void 0,void 0,(function(){var r;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,e.eth.getCode(t)];case 1:return[2,"0x00"!==(r=a.sent())&&"0x"!==r]}}))}))},t.getContract=function(e,t,r){return new e.eth.Contract(t,r)},t.getContractAddresses=function(e){var t=s.ContractAddresses[e];if(!t)throw new n.ContractError("No contracts found for the specified network id ".concat(e,"."));return t},t.mergeConfiguration=function(e,t){var r={};return Object.keys(t).forEach((function(e){return r[e]=t[e]})),Object.keys(e).forEach((function(t){return r[t]=e[t]})),r},t.getRevertReason=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,r,s;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,web3.eth.getTransaction(e)];case 1:t=a.sent(),r=t.blockNumber,a.label=2;case 2:return a.trys.push([2,4,,5]),delete t.hash,delete t.blockHash,delete t.blockNumber,delete t.transactionIndex,delete t.v,delete t.r,delete t.s,[4,web3.eth.call(t,r)];case 3:return(s=(s=a.sent()).startsWith("0x")?s:"0x"+s)&&s.substr(138)?[2,web3.utils.toAscii(s.substr(138))]:[2,"Cannot get reason - No return value"];case 4:return[2,a.sent()];case 5:return[2]}}))}))}},670:e=>{e.exports=require("@rsksmart/rif-relay-client")},820:e=>{e.exports=require("@rsksmart/rif-relay-contracts")},622:e=>{e.exports=require("loglevel")},752:e=>{e.exports=require("tslib")},519:e=>{e.exports=require("web3")},76:e=>{e.exports=require("web3-utils")}},t={};function r(a){var s=t[a];if(void 0!==s)return s.exports;var n=t[a]={exports:{}};return e[a](n,n.exports,r),n.exports}var a={};(()=>{var e=a;Object.defineProperty(e,"__esModule",{value:!0}),e.DefaultRelayingServices=void 0;var t=r(231);Object.defineProperty(e,"DefaultRelayingServices",{enumerable:!0,get:function(){return t.DefaultRelayingServices}})})(),module.exports=a})();